#!/bin/sh
set -o posix

anisotime_version='0.0.1'

#Emulates readlink -f hoge
__readlink_f (){
  TARGET_FILE=$1
  if [ "$(echo "$TARGET_FILE" | cut -c 1-2)" = "~/" ]; then
    TARGET_FILE=$HOME/${TARGET_FILE#\~/}
  fi
  while [ "$TARGET_FILE" != "" ]; do
      cd "$(dirname "$TARGET_FILE")" || exit 60
      FILENAME="$(basename "$TARGET_FILE")"
      TARGET_FILE="$(readlink "$FILENAME")"
  done
  if [ "$FILENAME" = "." ]; then
    echo "$(pwd -P)"
  else
    echo "$(pwd -P)/$FILENAME"
  fi
}

if [ -z "$KIBRARY_HOME" ]; then
  export KIBRARY_HOME=$(dirname "$(__readlink_f "$(dirname $0)")")
  printf "KIBRARY_HOME is %s.\n" "$KIBRARY_HOME." 1>&2
fi

KIBRARY_BIN="$KIBRARY_HOME/bin"

KIBRARY=$(find "$KIBRARY_BIN" -type f -name 'kib*jar' | tail -n1)

if [ -z "$JAVA" ]; then
  JAVA='java'
  echo "JAVA is set to be 'java'. ($(command -v java))" 1>&2
fi
export JAVA

if ! "$KIBRARY_BIN/javaCheck" -r >/dev/null 2>&1; then
  "$KIBRARY_BIN/javaCheck"
  exit 1
fi

"$JAVA" -cp "$KIBRARY" io.github.kensuke1984.anisotime.ANISOtime "$@"
exit $?
