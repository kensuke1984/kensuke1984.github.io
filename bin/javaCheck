#!/bin/sh
set -o posix

usage_exit() {
  echo "Usage: $0 [-i] [-r] [-p] [-l] [-k]" 1>&2
  echo "Check the versions of Java in Kibrary if exists, otherwise in PATH"
#  echo "  -r $0 checks if the installed Java can run Kibrary and does not care about the Java compiler. If this option is not specified, $0 also checks if the installed Java compiler can compile Kibrary."
  echo "  -i prints java and javac version in PATH."
#  echo "  -p prints or checks java and javac version in PATH even Kibrary has ones."
#  echo "  -k prints or checks java and javac version in Kibrary, if there are none in Kibrary, always error exits."
#  echo "  -l checks both java and javac not only can run Kibrary but are the latest. If -r option is specified, the version of javac is not checked."
  exit 1
}

while getopts ilrkp OPT
do
  case $OPT in
    "i" ) readonly FLG_I="TRUE" ;;
    "k" ) readonly FLG_K="TRUE" ;;
    "r" ) readonly FLG_R="TRUE" ;;
    "p" ) readonly FLG_P="TRUE" ;;
    "l" ) readonly FLG_L="TRUE" ;;
    "?" ) usage_exit;;
  esac
done

if [ -n "$FLG_K" ] && [ -n "$FLG_P" ]; then
  echo " -k and -p can not be used simultaneously."
  exit 1
fi

if [ -e "$HOME"/.Kibrary/bin/.kibraryrc ]; then
  if [ -n "$FLG_K" ]; then
    . "$HOME"/.Kibrary/bin/.kibraryrc -k || return 1
  elif [ -n "$FLG_P" ]; then
    . "$HOME"/.Kibrary/bin/.kibraryrc -p || return 1
  else
    . "$HOME"/.Kibrary/bin/.kibraryrc -- || return 1
  fi
else
  printf "No file for variables. Please reinstall Kibrary.\\n" 1>&2
  exit 71
fi

print_get_java(){
  printf "Get the latest Java \\033[1;31m%s\\033[m from Oracle (https://www.oracle.com/technetwork/java/javase/downloads/index.html).\\n" "$latest_java8_version" 1>&2
  printf "If you want to install automatically, launch the script as below (copy and paste):\\n" 1>&2
  printf "%s\\n" "$KIBRARY_BIN/javaInstall" 1>&2
  return
}

if command -v "$JAVA" 1>/dev/null 2>&1; then
  java_version=$($JAVA -version 2>&1 | awk '/version/{gsub(/\x22/,"",$3);print $3}')
else
  printf "Java Runtime Environment is not found.\\n"
  exit 250
fi

if command -v "$JAVAC" 1>/dev/null 2>&1; then
  javac_version=$($JAVAC -version 2>&1 | awk '{print $2}')
#  javac_version_final_number=${javac_version#1.8.0_}
elif [ -z "$FLG_R" ]; then
  printf "Java compiler is not found.\\n"
  exit 255
fi
#echo "$javac_version"

if [ -n "$FLG_I" ]; then
  printf "java %s\\n" "$java_version"
  printf "javac %s\\n" "$javac_version"
  exit 0
fi

#jsp='https://java.com/en/download/installed8.jsp'
#latest_version=\
#$( (curl -s -L $jsp || wget -q -O - $jsp) | awk -F= '/latest8/{gsub(/^[^[:digit:]]*|\x27.*$/, "", $2); #print $2}')

########### since 2018/11/21
jsp='https://javadl-esd-secure.oracle.com/update/baseline.version'
#latest_version=1.8.0_191
latest_version_list=\
$(curl -s -L $jsp)
latest_java11_version=$(echo "$latest_version_list" | grep '^11')
latest_java10_version=$(echo "$latest_version_list" | grep '^10')
latest_java9_version=$(echo "$latest_version_list" | grep '^9')
latest_java8_version=$(echo "$latest_version_list" | grep '^1\.8')
latest_java7_version=$(echo "$latest_version_list" | grep '^1\.7')
latest_java6_version=$(echo "$latest_version_list" | grep '^1\.6')
latest_java5_version=$(echo "$latest_version_list" | grep '^1\.5')
latest_java4_version=$(echo "$latest_version_list" | grep '^1\.4')
#exit

#  version=11
case "$java_version" in
#Java 8
  1.8* )
    printf "You use Java 8 (%s).\\n" "$java_version"
    if [ "$latest_java8_version" = "$java_version" ] || [ "$latest_java8_version" \< "$java_version" ]; then
      exit 0
    else
      printf "It's not latest. Please set \$JAVA the latest Java 8.\\n"
      exit 8
    fi
     ;;
#Java 9
  9* )
    printf "It's amaging that you use Java 9 (%s)!\\n" "$java_version"
    printf "I am sorry, however, a bit afraid of the compatibility.\\n"
    printf "It is NOT an LTS release.\\n"
    if [ "$latest_java9_version" = "$java_version" ] || [ "$latest_java9_version" \< "$java_version" ]; then
      printf "But.. anyway it's the latest Java 9.\\n"
      printf "Please set \$JAVA the latest Java 8, if there's anything wrong. I will catch up soon.\\n"
      exit 0
    else
      printf "It's not latest. Please set \$JAVA the latest Java 9.\\n"
      exit 9
    fi
     ;;
#Java 10 
  10* )
    printf "It's amaging that you use Java 10 (%s)!\\n" "$java_version"
    printf "I am sorry, however, a bit afraid of the compatibility.\\n"
    printf "It is NOT an LTS release.\\n"
    if [ "$latest_java10_version" = "$java_version" ] || [ "$latest_java10_version" \< "$java_version" ]; then
      printf "But.. anyway it's the latest Java 10.\\n"
      printf "Please set \$JAVA the latest Java 8, if there's anything wrong. I will catch up soon.\\n"
      exit 0
    else
      printf "It's not latest. Please set \$JAVA the latest Java 10.\\n"
      exit 10
    fi
    ;; 
#Java 11
  11* )
    printf "It's amaging that you use Java 11 (%s) (LTS)!\\n" "$java_version"
    printf "I am sorry, however, a bit afraid of the compatibility.\\n"
    if [ "$latest_java11_version" = "$java_version" ] || [ "$latest_java11_version" \< "$java_version" ]; then
      printf "But.. anyway it's the latest Java 11.\\n"
      printf "Please set \$JAVA the latest Java 8, if there's anything wrong. I will catch up soon.\\n"
      exit 0
    else
      printf "\\033[4mIn addtion\\e[m, its version \\033[1;31m%s\\033[m may not be the latest \\033[1;31m%s\\033[m.\\n" "$java_version" "$latest_java11_version"
      printf "It's not latest. Please set \$JAVA the latest Java 11.\\n"
      exit 11
    fi      
    ;;
  * )
    printf "Installed Java version is \\033[1;31m%s\\033[m. You need \\033[4mJava 8\\033[m.\\n" "$java_version"
    print_get_java
    exit 255
    ;;
esac




